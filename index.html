---
layout: map
permalink: /
group: navigation
navid: home
navtitle: Map
navweight: 0
---

<script>
	var map;

	var tilelayers = { };
	var overlays = {
		"Region names": null,
		"Map names": null,
		"Map boundaries": null
	}

	var continents = { };

	var city_maps = [ // Add the cities since there's no other way of separating normal maps from instanced maps, other than getting event maps and manually adding the cities
		18, // Divinity's Reach
		50, // Lion's Arch
		91, // The Grove
		139, // Rata Sum
		218, // Black Citadel
		326, // Hoelbrak
	];

	var dungeon_maps = [
		33, // Ascalonian Catacombs
		76, // Caudecus's Manor
		68, // Twilight Arbor
		63, // Sorrow's Embrace
		69, // Citadel of Flame
		71, // Honor of the Waves
		81, // Crucible of Eternity
		112 // The Ruined City of Arah
	];


	function onOverlayAdd(e) {
		switch (e.name) {
			case "Map names":
				$(".map-label").fixMapIconAnchor();
				break;
			case "Region names":
				$(".region-label").fixMapIconAnchor();
				break;
		}
	}

	function onBaselayerChange(e) {
		setContinentView(continents[e.name], 1);
	}

	function onZoomEnd(e) {
		var zoom = map.getZoom();
		$("#map").attr("zoom-level", zoom);
		$(".region-label").fixMapIconAnchor();
	}

	function setContinentView(continent, floor_id) {
		var name = continent.name;
		var width = continent.continent_dims[0];
		var height = continent.continent_dims[1];

		tilelayers[name].setUrl("https://{s}.guildwars2.com/" + continent.continent_id + "/" + floor_id + "/{z}/{x}/{y}.jpg")
		setMaxBounds(map, 0, 0, width, height);
		map.setView(unproject(map, [width / 2, height / 2]), 3);

		if (continents[name].map_floor[floor_id] === undefined) {
			getGW2API("/v1/map_floor.json?continent_id=" + continent.continent_id + "&floor=" + floor_id, function(data) {
				continents[name].map_floor[floor_id] = data;
				if (data.clamped_view !== undefined) {
					setMaxBounds(map, data.clamped_view[0][0], data.clamped_view[0][1], data.clamped_view[1][0], data.clamped_view[1][1]);
				}
				placeRegionNames(map, overlays, data.regions);
			});
		} else {
			var data = continents[name].map_floor[floor_id];
			if (data.clamped_view !== undefined) {
				setMaxBounds(map, data.clamped_view[0][0], data.clamped_view[0][1], data.clamped_view[1][0], data.clamped_view[1][1]);
			}
			placeRegionNames(map, overlays, data.regions);
		}

		if (continents[name].maps === undefined) {
			getGW2API(["/v1/map_names.json", "/v1/maps.json"], function(data) {
				var data_mapnames = data[0];
				var data_maps = data[1];

				var mapData = data_maps.maps;
				var maps = { };

				var default_maps = data_mapnames;
				if (continent.continent_id != 1) {
					default_maps = mapData;
				}

				for (var i in default_maps) {
					var id = i;
					if (default_maps[i].id !== undefined) {
						id = default_maps[i].id;
					}
					if (mapData[id] !== undefined && mapData[id].continent_id == continent.continent_id) {
						maps[id] = mapData[id];
						maps[id].map_id = id;
						maps[id].map_type = "";
					}
				}
				for (var i in city_maps) {
					var id = city_maps[i];
					if (mapData[id] != undefined && mapData[id].continent_id == continent.continent_id) {
						maps[id] = mapData[id];
						maps[id].map_id = id;
						maps[id].map_type = "city";
					}
				}
				for (var i in dungeon_maps) {
					var id = dungeon_maps[i];
					if (mapData[id] != undefined && mapData[id].continent_id == continent.continent_id) {
						maps[id] = mapData[id];
						maps[id].map_id = id;
						maps[id].map_type = "dungeon";
					}
				}

				var floor_maps = { };
				for (var mapData in maps) {
					mapData = maps[mapData];
					for (var floor in mapData.floors) {
						floor = mapData.floors[floor];
						if (floor_maps[floor] === undefined) {
							floor_maps[floor] = { };
						}
						floor_maps[floor][mapData.map_id] = mapData;
					}
				}

				continents[name].maps = floor_maps;
				placeMapNames(map, overlays, floor_maps[floor_id]);
				placeMapBoundaries(map, overlays, floor_maps[floor_id]);
			});
		} else {
			placeMapNames(map, overlays, continents[name].maps[floor_id]);
			placeMapBoundaries(map, overlays, continents[name].maps[floor_id]);
		}
	}

	$(function () {
		map = L.map("map", { crs: L.CRS.Simple });
		map.on("baselayerchange", onBaselayerChange);
		map.on("overlayadd", onOverlayAdd);
		map.on("zoomend", onZoomEnd);

		getGW2API("/v1/continents.json", function(data) {
			$.each(data.continents, function(id, continent) {
				var name = continent.name;
				var minZoom = continent.min_zoom;
				var maxZoom = continent.max_zoom;
				continents[name] = continent;
				continents[name].continent_id = id;
				continents[name].map_floor = { };

				tilelayers[name] = L.tileLayer("https://{s}.guildwars2.com/" + id + "/1/{z}/{x}/{y}.jpg", {
					minZoom: minZoom,
					maxZoom: maxZoom,
					continuousWorld: true,
					subdomains: ["tiles", "tiles1", "tiles2", "tiles3", "tiles4"],
				});
			});

			tilelayers["Tyria"].addTo(map);
			setContinentView(continents["Tyria"], 1);

			$.each(overlays, function(id, value) {
				overlays[id] = L.layerGroup().addTo(map);
			});
			L.control.layers(tilelayers, overlays).addTo(map);
		});
	});
</script>
